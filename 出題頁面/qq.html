<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>筆記出題系統</title>
<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f2f5;
    margin: 40px auto;
    max-width: 720px;
    color: #333;
  }

  h1 {
    text-align: center;
    color: #2c3e50;
  }

  label,
  textarea,
  input,
  button,
  pre {
    font-size: 16px;
    width: 100%;
    margin-bottom: 18px;
  }

  textarea {
    resize: vertical;
    min-height: 160px;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }

  input[type="number"] {
    max-width: 120px;
    padding: 10px 15px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  button {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 20px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    max-width: 200px;
  }

  button:hover {
    background-color: #0056b3;
  }

  #quizForm {
    margin-top: 30px;
  }

  #quizForm h2 {
    color: #34495e;
    margin-bottom: 20px;
  }

  #quizContainer > div {
    background: white;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 10px;
    text-align: left; 
  }

  .question-text {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 12px;
    color: #2c3e50;
  }

  .option-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .option-group label {
   display: flex;
   align-items: center;
    gap: 10px;
    padding: 6px 0;
    font-size: 16px;
    cursor: pointer;
    user-select: none;
    background: none;       
    border-radius: 4px;
  }

  .option-group label:hover {
    background: #f5faff;
  }

  .option-group input[type="radio"] {
    margin: 0 4px 0 0;
    accent-color: #007bff;  
    width: 18px;
    height: 18px;
  }

  .option-group span {
    white-space: normal;
    word-break: break-all;
    font-size: 16px;
  }
  .score-label {
    font-weight: normal;
    font-size: 14px;
    color: #888;
  }

  .result {
    margin-top: 25px;
    font-size: 18px;
    font-weight: bold;
    color: #27ae60;
    text-align: center;
  }
  #modalOverlay {
    display:none; position:fixed; z-index:1000; top:0; left:0; width:100vw; height:100vh;
    background:rgba(30,44,70,0.18); backdrop-filter:blur(1.5px);
  }
  #modalContent {
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    background:white; border-radius:18px; box-shadow:0 8px 32px rgba(0,0,0,0.16);
    padding:36px 36px 26px 36px; display:flex; flex-direction:column; align-items:center;
  }
</style>
</head>
<body>
<h1>筆記出題系統（可作答）</h1>

<div id="inputArea">
  <label for="notes">請貼上筆記內容：</label>
  <textarea id="notes" rows="10" placeholder="請貼上你的筆記..."></textarea>

  <label for="count">請輸入題目數量（最多20題）：</label>
  <input type="number" id="count" min="1" max="20" value="10" />

  <button onclick="generateQuestions()">產生選擇題</button>
</div>
  <form id="quizForm" style="display:none;">
    <h2>請開始作答：</h2>
    <div id="quizContainer"></div>
    <button type="submit">提交作答並送出成績</button>
  </form>

  <div class="result" id="scoreResult"></div>
  <div id="reviewArea" style="display:none;"></div>
  <div id="modalOverlay">
    <div id="modalContent">
      <div id="modalSpinner" style="margin-bottom:18px;">
        <img src="${API_BASE}/static/monkey-running.gif" alt="Loading..." style="width:64px; height:64px;">
      </div>
      <div id="modalMsg" style="font-size:20px;font-weight:600;color:#2c3e50;text-align:center;letter-spacing:1px;"></div>
    </div>
  </div>

  <script>
    const API_BASE = "https://3bfec23ed4bf.ngrok-free.app";
    //
    function showModal(msg, showSpinner = false) {
      document.getElementById("modalOverlay").style.display = "block";
      document.getElementById("modalMsg").innerHTML = msg;
      document.getElementById("modalSpinner").style.display = showSpinner ? "block" : "none";
    }
    function hideModal() {
      document.getElementById("modalOverlay").style.display = "none";
    }

    let questionsData = [];
    let label = "";

    async function generateQuestions() {
      const notes = document.getElementById("notes").value.trim();
      const count = parseInt(document.getElementById("count").value) || 10;

      if (!notes) {
        alert("請輸入筆記內容");
        return;
      }

      showModal("題目生成中，請稍候...", true);
      
      //字元控制在500，否則分次送
      const chunks = [];
      const chunkSize = 500;
      for (let i = 0; i < notes.length; i += chunkSize) {
        chunks.push(notes.substring(i, i + chunkSize));
      }

      const response = await fetch(`${API_BASE}/generate_questions`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ notes_chunks: chunks, count: count })
      });

      hideModal();

      if (response.ok) {
        const data = await response.json();
        questionsData = data.questions;

        const quizContainer = document.getElementById("quizContainer");
        quizContainer.innerHTML = "";
        questionsData.forEach((q, i) => {
          const div = document.createElement("div");
          div.innerHTML = `
            <p>
              <strong>第 ${i + 1} 題：</strong> ${q.question}
              <span class="score-label">（配分：${q["配分"] || "未知"}）</span>
            </p>
            <div class="option-group">
            ${q.options.map((opt, j) =>
              `<label>
                <input type="radio" name="q${i}" value="${j}" required />
                ${opt}
              </label>`
            ).join("")}
           </div>
          `;
          quizContainer.appendChild(div);
        });

        document.getElementById("quizForm").style.display = "block";
        document.getElementById("inputArea").style.display = "none";
        const now = new Date();
        label = `第${now.getMonth() + 1}月${now.getDate()}日-${now.getHours()}時-${now.getMinutes()}分`;
      } 
    }
    function answerToIndex(answerStr) {
      if (typeof answerStr === "string" && answerStr.match(/^[A-D]$/i)) {
       return answerStr.toUpperCase().charCodeAt(0) - 65;
     }
     if (!isNaN(answerStr)) return Number(answerStr);
      return null;
    }   

    document.getElementById("quizForm").addEventListener("submit", function(e) {
     e.preventDefault();

     let score = 0;
     let maxScore = 0;
     let correctCount = 0;
     let reviewHtml = '<h3>作答結果</h3>';

    questionsData.forEach((q, i) => {
    // 算配分
      let point = 1;
      if (q["配分"]) {
       const match = String(q["配分"]).match(/\d+/);
       if (match) point = parseInt(match[0], 10);
      }
      maxScore += point;

      const selected = document.querySelector(`input[name="q${i}"]:checked`);
      const myAnsIndex = selected ? Number(selected.value) : null;
      const correctIndex = answerToIndex(q.answer);

      const correct = myAnsIndex === correctIndex;
      if (correct) {
        score += point;
        correctCount++;
      }
    
     function findOptText(idx) {
      if (typeof idx === "number" && q.options[idx]) return q.options[idx];
      return "";
    }

    reviewHtml += `
      <div style="background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; border-radius: 10px; text-align: left;">
        <p class="question-text" style="font-weight: 600;">
          第 ${i+1} 題：${q.question}
          <span class="score-label">（配分：${q["配分"]||"未知"}）</span>
        </p>
        <div class="option-group" style="display: flex; flex-direction: column; gap: 8px;">
          ${q.options.map((opt, j) => {
            let border = "";
            let bg = "";
            let icon = "";
            if (j === myAnsIndex && j === correctIndex) {
              // 選正確的答案
              border = "2px solid #4caf50";
              bg = "#e5fbe5";
              icon = `<span style="color:#4caf50;font-size:1.2em; margin-left:6px;">✔</span>`;
            } else if (j === myAnsIndex && j !== correctIndex) {
              // 選錯的答案
              border = "2px solid #e74c3c";
              bg = "#fdeaea";
              icon = `<span style="color:#e74c3c;font-size:1.2em; margin-left:6px;">✘</span>`;
            } else if (j === correctIndex) {
              // 正確答案（沒選到）
              border = "2px solid #4caf50";
              bg = "#fffbe6";
              icon = `<span style="color:#4caf50; margin-left:6px;">（正確答案）</span>`;
            }
            return `
              <label style="
                display: flex; align-items: center; gap: 10px; 
                padding: 6px 0; font-size: 16px; user-select: none;
                background: ${bg}; border-radius: 4px;
                border:${border};
                margin-bottom: 0px;
                ">
                <input type="radio" name="dummy${i}" value="${j}" disabled ${j === myAnsIndex ? "checked" : ""}>
                ${opt} ${icon}
              </label>
            `;
          }).join("")}
        </div>
        ${(!correct && myAnsIndex !== null)
            ? `<div style="background:#fffbe6;padding:8px 12px;margin-top:8px;border-radius:4px;color:#e67e22;">
                正確答案為：${findOptText(correctIndex)}
              </div>`
            : ""}
      </div>
    `;
  });

  // 成績條在最上面
  const total = questionsData.length;
  const percent = Math.round((score / maxScore) * 100);
  const scoreInfo = `
    <div style="background:#f3f8ff;padding:22px 18px 12px 18px;border-radius:12px;margin-bottom:22px;text-align:left;">
      <div style="font-size:22px;color:#1d70b8;font-weight:bold;margin-bottom:8px;">
        作答結果：${score} / ${maxScore} 分
      </div>
      <div style="font-size:18px;margin-bottom:2px;">
        ${total} 題對了 <span style="color:#4caf50;font-weight:bold;">${correctCount}</span> 題
      </div>
      <div style="font-size:16px;color:#888;">
        答對率 ${percent}%
      </div>
    </div>
  `;
  reviewHtml = scoreInfo + reviewHtml;
  reviewHtml += `<button id="finalSubmit" style="margin:24px 0 0 0;padding:10px 32px;font-size:18px;border:none;border-radius:6px;background:#007bff;color:#fff;cursor:pointer;">確認送出成績</button>`;

  document.getElementById("reviewArea").innerHTML = reviewHtml;
  document.getElementById("reviewArea").style.display = "block";
  document.getElementById("quizForm").style.display = "none";
  document.getElementById("scoreResult").textContent = "";

  // 確認送出分數
  document.getElementById("finalSubmit").onclick = async function() {
    await fetch(`${API_BASE}/add_score`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ score: score, week: label })
    });
    showModal(
      `<img src="${API_BASE}/static/monkey-running.gif" alt="Monkey" style="width:80px;height:80px;display:block;margin:0 auto 14px auto;">
       你得了 <span style="color:#007bff;font-size:1.1em">${score}</span> 分！<br>即將跳轉...`,
      false
    );
    //延遲的時間
    setTimeout(() => {
      window.location.href = `${API_BASE}/test_ui`;
    }, 2000);
  };
});
  </script>
</body>
</html>